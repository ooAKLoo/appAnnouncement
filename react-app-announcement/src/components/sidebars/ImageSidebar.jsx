import React, { useState, useRef } from 'react';
import { useApp } from '../../context/AppContext';
import {
  Image as ImageIcon,
  Move,
  Maximize2,
  Square,
  Circle,
  Droplet,
  Sun,
  Contrast,
  Palette,
  RotateCw,
  FlipHorizontal,
  FlipVertical,
  Upload,
  X,
  ArrowLeft,
  Scissors
} from 'lucide-react';

function ImageSidebar({ isActive }) {
  const { state, updateElementStyle, updateDynamicComponent, updateAppInfo, updateProductHuntInfo, deselectElement, setCurrentPanel } = useApp();
  const selected = state.selectedElement;
  const fileInputRef = useRef(null);
  const [aspectRatioLocked, setAspectRatioLocked] = useState(true);
  const [currentAspectRatio, setCurrentAspectRatio] = useState(1); // ËÆ∞ÂΩïÂΩìÂâçÂÆΩÈ´òÊØî

  // ÊèêÂèñÂä®ÊÄÅÁªÑ‰ª∂ IDÔºàÊîØÊåÅ ID ‰∏≠ÂåÖÂê´Â∞èÊï∞ÁÇπÔºâ
  const extractComponentId = (element) => {
    if (!element) return null;
    // ‰ΩøÁî®Ê≠£ÂàôÂåπÈÖç dynamicComponents.{id}.content Ê†ºÂºè
    const match = element.match(/^dynamicComponents\.(.+)\.content$/);
    return match ? match[1] : null;
  };

  // Ê£ÄÊµãÊòØÂê¶ÊòØÂõæÁâáÁ±ªÂûãÁöÑÂÖÉÁ¥†
  const isImageElement = () => {
    if (!selected) return false;
    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂä®ÊÄÅÁªÑ‰ª∂ÂõæÁâá
    if (selected.element && selected.element.startsWith('dynamicComponents.')) {
      const componentId = extractComponentId(selected.element);
      if (componentId) {
        const component = state.dynamicComponents?.find(c => String(c.id) === String(componentId));
        return component?.type === 'image' || component?.type === 'icon';
      }
    }
    // Ê£ÄÊü•ÊòØÂê¶ÊòØ appInfo.icon ÊàñÂÖ∂‰ªñÂõæÊ†áË∑ØÂæÑ
    return selected.element?.includes('icon') || selected.element?.includes('image');
  };

  // Ëé∑ÂèñÂΩìÂâçÊ†∑Âºè
  const currentStyles = selected ? (state.elementStyles[selected.id] || {}) : {};

  // Ëé∑ÂèñÂä®ÊÄÅÁªÑ‰ª∂ÔºàÂ¶ÇÊûúÊòØÔºâ
  const getDynamicComponent = () => {
    if (!selected) return null;
    if (selected.element && selected.element.startsWith('dynamicComponents.')) {
      const componentId = extractComponentId(selected.element);
      if (componentId) {
        return state.dynamicComponents?.find(c => String(c.id) === String(componentId));
      }
    }
    return null;
  };

  const component = getDynamicComponent();

  // ËæÖÂä©ÂáΩÊï∞ÔºöËß£ÊûêÊï∞ÂÄºÔºàÂøÖÈ°ªÂú® useEffect ‰πãÂâçÂÆö‰πâÔºâ
  const parseValue = (value, defaultValue) => {
    if (typeof value === 'number') return value;
    if (typeof value === 'string') {
      const parsed = parseInt(value);
      return isNaN(parsed) ? defaultValue : parsed;
    }
    return defaultValue;
  };

  const parseFloatValue = (value, defaultValue) => {
    if (typeof value === 'number') return value;
    if (typeof value === 'string') {
      const parsed = parseFloat(value);
      return isNaN(parsed) ? defaultValue : parsed;
    }
    return defaultValue;
  };

  // üéØ ÂàùÂßãÂåñÂÆΩÈ´òÊØî - ÂΩìÁªÑ‰ª∂Âä†ËΩΩÊàñÂ∞∫ÂØ∏ÊîπÂèòÊó∂Êõ¥Êñ∞ÔºàÂøÖÈ°ªÂú®ÊâÄÊúâ return ‰πãÂâçÔºâ
  React.useEffect(() => {
    if (!selected || !isImageElement()) return;

    const width = parseValue(currentStyles.width, 100);
    const height = parseValue(currentStyles.height, 100);
    if (width && height) {
      const ratio = width / height;
      setCurrentAspectRatio(ratio);
      console.log('üìê ÂàùÂßãÂåñÂÆΩÈ´òÊØî:', ratio, { width, height });
    }
  }, [selected?.id, currentStyles.width, currentStyles.height]);

  // Â¶ÇÊûúÈù¢ÊùøÊ≤°ÊøÄÊ¥ªÊàñÊ≤°ÊúâÈÄâ‰∏≠ÂÖÉÁ¥†Ôºå‰∏çÊòæÁ§∫
  if (!isActive || !selected) return null;

  // Â¶ÇÊûú‰∏çÊòØÂõæÁâáÂÖÉÁ¥†Ôºå‰∏çÊòæÁ§∫
  if (!isImageElement()) {
    return null;
  }

  const updateStyle = (property, value) => {
    updateElementStyle(selected.id, { [property]: value });
  };

  // Â§ÑÁêÜÂÆΩÂ∫¶ÂèòÂåñÔºàÊîØÊåÅÈîÅÂÆöÊØî‰æãÔºâ
  const handleWidthChange = (newWidth) => {
    const width = parseInt(newWidth);
    if (isNaN(width) || width <= 0) return;

    if (aspectRatioLocked && currentAspectRatio) {
      // ÈîÅÂÆöÊØî‰æãÔºöÊ†πÊçÆÊñ∞ÂÆΩÂ∫¶ËÆ°ÁÆóÊñ∞È´òÂ∫¶
      const newHeight = Math.round(width / currentAspectRatio);
      console.log('üîí ÈîÅÂÆöÊØî‰æãË∞ÉÊï¥:', { width, height: newHeight, ratio: currentAspectRatio });
      updateElementStyle(selected.id, {
        width: `${width}px`,
        height: `${newHeight}px`
      });
    } else {
      // Ëá™Áî±Áº©ÊîæÔºöÂè™Êõ¥Êñ∞ÂÆΩÂ∫¶
      updateStyle('width', `${width}px`);
      // Êõ¥Êñ∞ÂÆΩÈ´òÊØî
      const currentHeight = parseValue(currentStyles.height, 100);
      setCurrentAspectRatio(width / currentHeight);
    }
  };

  // Â§ÑÁêÜÈ´òÂ∫¶ÂèòÂåñÔºàÊîØÊåÅÈîÅÂÆöÊØî‰æãÔºâ
  const handleHeightChange = (newHeight) => {
    const height = parseInt(newHeight);
    if (isNaN(height) || height <= 0) return;

    if (aspectRatioLocked && currentAspectRatio) {
      // ÈîÅÂÆöÊØî‰æãÔºöÊ†πÊçÆÊñ∞È´òÂ∫¶ËÆ°ÁÆóÊñ∞ÂÆΩÂ∫¶
      const newWidth = Math.round(height * currentAspectRatio);
      console.log('üîí ÈîÅÂÆöÊØî‰æãË∞ÉÊï¥:', { width: newWidth, height, ratio: currentAspectRatio });
      updateElementStyle(selected.id, {
        width: `${newWidth}px`,
        height: `${height}px`
      });
    } else {
      // Ëá™Áî±Áº©ÊîæÔºöÂè™Êõ¥Êñ∞È´òÂ∫¶
      updateStyle('height', `${height}px`);
      // Êõ¥Êñ∞ÂÆΩÈ´òÊØî
      const currentWidth = parseValue(currentStyles.width, 100);
      setCurrentAspectRatio(currentWidth / height);
    }
  };

  const handleBack = () => {
    deselectElement();
    setCurrentPanel('design');
  };

  // Â§ÑÁêÜÂõæÁâáÊõøÊç¢
  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      const imageUrl = event.target.result;
      console.log('üñºÔ∏è ÂõæÁâá‰∏ä‰º†ÂÆåÊàêÔºåURL:', imageUrl.substring(0, 50) + '...');
      console.log('üîç ÂΩìÂâçÈÄâ‰∏≠ÂÖÉÁ¥†‰ø°ÊÅØ:', {
        selected,
        component,
        elementPath: selected?.element,
        elementId: selected?.id
      });

      if (component) {
        // Êõ¥Êñ∞Âä®ÊÄÅÁªÑ‰ª∂ÁöÑÂÜÖÂÆπ
        console.log('üîÑ Êõ¥Êñ∞Âä®ÊÄÅÁªÑ‰ª∂:', component.id);
        console.log('üîç Âä®ÊÄÅÁªÑ‰ª∂ dataPath:', component.dataPath);

        // ÂÖàÊõ¥Êñ∞Âä®ÊÄÅÁªÑ‰ª∂ÁöÑ content
        updateDynamicComponent(component.id, { content: imageUrl });

        // üî• ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂ¶ÇÊûúÂä®ÊÄÅÁªÑ‰ª∂ÂÖ≥ËÅîÂà∞ appInfo.iconImage Êàñ productHuntInfo.iconImageÔºå‰πüË¶ÅÊõ¥Êñ∞ state
        if (component.dataPath) {
          const pathParts = component.dataPath.split('.');
          console.log('üîç Ê£ÄÊü• dataPath:', component.dataPath, 'ÂàÜÂâ≤ÁªìÊûú:', pathParts);

          if (pathParts[0] === 'appInfo' && pathParts[1] === 'iconImage') {
            console.log('‚úÖ Âä®ÊÄÅÁªÑ‰ª∂ÂÖ≥ËÅîÂà∞ appInfo.iconImageÔºåÂêåÊó∂Êõ¥Êñ∞ state');
            updateAppInfo({ iconImage: imageUrl });
          } else if (pathParts[0] === 'productHuntInfo' && pathParts[1] === 'iconImage') {
            console.log('‚úÖ Âä®ÊÄÅÁªÑ‰ª∂ÂÖ≥ËÅîÂà∞ productHuntInfo.iconImageÔºåÂêåÊó∂Êõ¥Êñ∞ state');
            updateProductHuntInfo({ iconImage: imageUrl });
          }
        }
      } else {
        // Êõ¥Êñ∞ Editable ÂÖÉÁ¥†ÔºàappInfo.icon Á≠âÔºâ
        const path = selected.element;
        console.log('üîÑ Êõ¥Êñ∞ Editable ÂÖÉÁ¥† path:', path);

        if (path) {
          const pathParts = path.split('.');
          console.log('üìù Ë∑ØÂæÑÂàÜÂâ≤ÁªìÊûú:', pathParts);

          if (pathParts[0] === 'appInfo' && pathParts[1] === 'icon') {
            // appInfo.icon ÈúÄË¶ÅÊõ¥Êñ∞ iconImage Â≠óÊÆµÊù•ÊòæÁ§∫ÂõæÁâá
            console.log('‚úÖ ÂåπÈÖçÂà∞ appInfo.iconÔºåÊõ¥Êñ∞ iconImage');
            updateAppInfo({ iconImage: imageUrl });
            console.log('‚úÖ updateAppInfo Ë∞ÉÁî®ÂÆåÊàê');
          } else if (pathParts[0] === 'appInfo') {
            console.log('‚úÖ Êõ¥Êñ∞ appInfo ÂÖ∂‰ªñÂ≠óÊÆµ:', pathParts[1]);
            updateAppInfo({ [pathParts[1]]: imageUrl });
          } else if (pathParts[0] === 'productHuntInfo' && pathParts[1] === 'icon') {
            // productHuntInfo.icon ‰πüÈúÄË¶ÅÊõ¥Êñ∞ÂØπÂ∫îÁöÑ iconImage Â≠óÊÆµ
            console.log('‚úÖ ÂåπÈÖçÂà∞ productHuntInfo.iconÔºåÊõ¥Êñ∞ iconImage');
            updateProductHuntInfo({ iconImage: imageUrl });
          } else if (pathParts[0] === 'productHuntInfo') {
            console.log('‚úÖ Êõ¥Êñ∞ productHuntInfo ÂÖ∂‰ªñÂ≠óÊÆµ:', pathParts[1]);
            updateProductHuntInfo({ [pathParts[1]]: imageUrl });
          } else {
            console.warn('‚ö†Ô∏è Êú™ÂåπÈÖçÂà∞‰ªª‰ΩïÊõ¥Êñ∞Ë∑ØÂæÑ:', pathParts);
          }
        } else {
          console.error('‚ùå Ê≤°ÊúâÊâæÂà∞ selected.element Ë∑ØÂæÑ');
        }
      }
    };
    reader.readAsDataURL(file);
  };

  // ÁøªËΩ¨ÂíåÊóãËΩ¨
  const handleFlipHorizontal = () => {
    const currentTransform = currentStyles.transform || '';
    const hasFlipH = currentTransform.includes('scaleX(-1)');
    const newTransform = hasFlipH
      ? currentTransform.replace('scaleX(-1)', 'scaleX(1)')
      : currentTransform + ' scaleX(-1)';
    updateStyle('transform', newTransform.trim());
  };

  const handleFlipVertical = () => {
    const currentTransform = currentStyles.transform || '';
    const hasFlipV = currentTransform.includes('scaleY(-1)');
    const newTransform = hasFlipV
      ? currentTransform.replace('scaleY(-1)', 'scaleY(1)')
      : currentTransform + ' scaleY(-1)';
    updateStyle('transform', newTransform.trim());
  };

  const handleRotate = (degrees) => {
    const currentRotation = parseValue(currentStyles.rotation, 0);
    const newRotation = (currentRotation + degrees) % 360;
    updateStyle('rotation', newRotation);
    updateStyle('transform', `rotate(${newRotation}deg) ${currentStyles.transform || ''}`.trim());
  };

  return (
    <div
      className="fixed left-4 top-20 bottom-4 w-80 bg-white rounded-xl shadow-xl border border-gray-200/50 flex flex-col overflow-hidden z-50 style-edit-panel"
      onClick={(e) => e.stopPropagation()}
    >
      {/* Ê†áÈ¢òÊ†è */}
      <div className="flex items-center justify-between p-4 border-b border-gray-100">
        <div className="flex items-center gap-2">
          <button
            onClick={handleBack}
            className="p-1 rounded-lg hover:bg-gray-100 transition-colors"
          >
            <ArrowLeft size={16} className="text-gray-500" />
          </button>
          <div className="w-8 h-8 rounded-lg bg-purple-50 flex items-center justify-center">
            <ImageIcon size={16} className="text-purple-600" />
          </div>
          <div>
            <h3 className="font-medium text-gray-900">ÂõæÁâáÁºñËæë</h3>
            <p className="text-xs text-gray-500">Ë∞ÉÊï¥ÂõæÁâáÊ†∑ÂºèÂíåÂ±ûÊÄß</p>
          </div>
        </div>
        <button
          onClick={deselectElement}
          className="p-1 rounded-lg hover:bg-gray-100 transition-colors"
        >
          <X size={16} className="text-gray-500" />
        </button>
      </div>

      {/* ÂÜÖÂÆπÂå∫Âüü */}
      <div className="flex-1 overflow-y-auto p-4 space-y-6">
        {/* ÊõøÊç¢ÂõæÁâá */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            <Upload size={14} className="inline mr-1" />
            ÊõøÊç¢ÂõæÁâá
          </label>
          <input
            ref={fileInputRef}
            type="file"
            accept="image/*"
            onChange={handleImageUpload}
            className="hidden"
          />
          <button
            onClick={() => fileInputRef.current?.click()}
            className="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-purple-400 hover:bg-purple-50 transition-all text-sm text-gray-600 hover:text-purple-600"
          >
            ÁÇπÂáª‰∏ä‰º†Êñ∞ÂõæÁâá
          </button>
        </div>

        {/* Â∞∫ÂØ∏Ë∞ÉÊï¥ */}
        <div>
          <h4 className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-3">
            <Maximize2 size={14} />
            Â∞∫ÂØ∏
          </h4>
          <div className="space-y-3">
            <div className="flex items-center gap-2">
              <label className="text-xs text-gray-600 w-12">ÂÆΩÂ∫¶</label>
              <input
                type="number"
                value={parseValue(currentStyles.width, 100)}
                onChange={(e) => handleWidthChange(e.target.value)}
                className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
              />
              <span className="text-xs text-gray-500">px</span>
            </div>
            <div className="flex items-center gap-2">
              <label className="text-xs text-gray-600 w-12">È´òÂ∫¶</label>
              <input
                type="number"
                value={parseValue(currentStyles.height, 100)}
                onChange={(e) => handleHeightChange(e.target.value)}
                className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
              />
              <span className="text-xs text-gray-500">px</span>
            </div>
            <button
              onClick={() => {
                setAspectRatioLocked(!aspectRatioLocked);
                // ÂàáÊç¢ÈîÅÂÆöÁä∂ÊÄÅÊó∂ÔºåÊõ¥Êñ∞ÂΩìÂâçÂÆΩÈ´òÊØî
                if (!aspectRatioLocked) {
                  const width = parseValue(currentStyles.width, 100);
                  const height = parseValue(currentStyles.height, 100);
                  setCurrentAspectRatio(width / height);
                  console.log('üîí ÂêØÁî®ÈîÅÂÆöÊØî‰æãÔºåÂΩìÂâçÊØî‰æã:', width / height);
                }
              }}
              className={`w-full text-xs py-1.5 rounded ${
                aspectRatioLocked ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600'
              }`}
            >
              {aspectRatioLocked ? 'üîí ÈîÅÂÆöÊØî‰æã' : 'üîì Ëá™Áî±Áº©Êîæ'}
            </button>
          </div>
        </div>

        {/* ‰ΩçÁΩÆ */}
        <div>
          <h4 className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-3">
            <Move size={14} />
            ‰ΩçÁΩÆ
          </h4>
          <div className="space-y-3">
            <div className="flex items-center gap-2">
              <label className="text-xs text-gray-600 w-12">X ÂùêÊ†á</label>
              <input
                type="number"
                value={parseValue(currentStyles.left, 0)}
                onChange={(e) => updateStyle('left', `${e.target.value}px`)}
                className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
              />
              <span className="text-xs text-gray-500">px</span>
            </div>
            <div className="flex items-center gap-2">
              <label className="text-xs text-gray-600 w-12">Y ÂùêÊ†á</label>
              <input
                type="number"
                value={parseValue(currentStyles.top, 0)}
                onChange={(e) => updateStyle('top', `${e.target.value}px`)}
                className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
              />
              <span className="text-xs text-gray-500">px</span>
            </div>
          </div>
        </div>

        {/* ÈÄÇÈÖçÊñπÂºè */}
        <div>
          <h4 className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-3">
            <Scissors size={14} />
            ÂõæÁâáÈÄÇÈÖç
          </h4>
          <div className="grid grid-cols-2 gap-2">
            {[
              { value: 'cover', label: 'Â°´ÂÖÖ', desc: 'Ë£ÅÂâ™Â°´Êª°' },
              { value: 'contain', label: 'ÂåÖÂê´', desc: 'ÂÆåÊï¥ÊòæÁ§∫' },
              { value: 'fill', label: 'Êãâ‰º∏', desc: 'ÂèòÂΩ¢Â°´ÂÖÖ' },
              { value: 'scale-down', label: 'Áº©Â∞è', desc: 'Áº©Â∞èÈÄÇÂ∫î' }
            ].map((fit) => (
              <button
                key={fit.value}
                onClick={() => updateStyle('objectFit', fit.value)}
                className={`p-2 rounded-lg border text-left transition-all ${
                  (currentStyles.objectFit || 'cover') === fit.value
                    ? 'border-purple-500 bg-purple-50'
                    : 'border-gray-200 hover:border-gray-300'
                }`}
              >
                <div className="text-xs font-medium text-gray-900">{fit.label}</div>
                <div className="text-xs text-gray-500">{fit.desc}</div>
              </button>
            ))}
          </div>
        </div>

        {/* ÂúÜËßí */}
        <div>
          <h4 className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-3">
            <Square size={14} />
            ÂúÜËßí
          </h4>
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <input
                type="range"
                min="0"
                max="100"
                value={parseValue(currentStyles.borderRadius, 0)}
                onChange={(e) => updateStyle('borderRadius', `${e.target.value}px`)}
                className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
              />
              <span className="text-sm text-gray-600 min-w-[50px]">
                {parseValue(currentStyles.borderRadius, 0)}px
              </span>
            </div>
            <div className="grid grid-cols-4 gap-2">
              {[0, 8, 16, 50].map((radius) => (
                <button
                  key={radius}
                  onClick={() => updateStyle('borderRadius', `${radius}px`)}
                  className={`p-2 text-xs rounded-lg border ${
                    parseValue(currentStyles.borderRadius, 0) === radius
                      ? 'border-purple-500 bg-purple-50'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  {radius === 50 ? 'ÂúÜÂΩ¢' : radius === 0 ? 'Áõ¥Ëßí' : `${radius}px`}
                </button>
              ))}
            </div>
          </div>
        </div>

        {/* ËæπÊ°Ü */}
        <div>
          <h4 className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-3">
            <Circle size={14} />
            ËæπÊ°Ü
          </h4>
          <div className="space-y-3">
            <div className="flex items-center gap-2">
              <label className="text-xs text-gray-600 w-12">Á≤óÁªÜ</label>
              <input
                type="range"
                min="0"
                max="10"
                value={parseValue(currentStyles.borderWidth, 0)}
                onChange={(e) => updateStyle('borderWidth', `${e.target.value}px`)}
                className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
              />
              <span className="text-xs text-gray-600 min-w-[40px]">
                {parseValue(currentStyles.borderWidth, 0)}px
              </span>
            </div>
            <div>
              <label className="text-xs text-gray-600 mb-1 block">È¢úËâ≤</label>
              <input
                type="color"
                value={currentStyles.borderColor || '#000000'}
                onChange={(e) => updateStyle('borderColor', e.target.value)}
                className="w-full h-8 rounded border border-gray-300"
              />
            </div>
            <div>
              <label className="text-xs text-gray-600 mb-1 block">Ê†∑Âºè</label>
              <div className="grid grid-cols-3 gap-2">
                {['solid', 'dashed', 'dotted'].map((style) => (
                  <button
                    key={style}
                    onClick={() => updateStyle('borderStyle', style)}
                    className={`p-2 text-xs rounded border ${
                      (currentStyles.borderStyle || 'solid') === style
                        ? 'border-purple-500 bg-purple-50'
                        : 'border-gray-200'
                    }`}
                  >
                    {style === 'solid' ? 'ÂÆûÁ∫ø' : style === 'dashed' ? 'ËôöÁ∫ø' : 'ÁÇπÁ∫ø'}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* Èò¥ÂΩ± */}
        <div>
          <h4 className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-3">
            <Droplet size={14} />
            Èò¥ÂΩ±
          </h4>
          <div className="grid grid-cols-2 gap-2">
            {[
              { label: 'Êó†', value: 'none' },
              { label: 'Â∞è', value: '0 1px 3px rgba(0,0,0,0.12)' },
              { label: '‰∏≠', value: '0 4px 6px rgba(0,0,0,0.1)' },
              { label: 'Â§ß', value: '0 10px 15px rgba(0,0,0,0.15)' },
              { label: 'ÁâπÂ§ß', value: '0 20px 25px rgba(0,0,0,0.2)' },
              { label: 'ÂèëÂÖâ', value: '0 0 20px rgba(147,51,234,0.5)' }
            ].map((shadow) => (
              <button
                key={shadow.label}
                onClick={() => updateStyle('boxShadow', shadow.value)}
                className={`p-2 text-xs rounded-lg border ${
                  (currentStyles.boxShadow || 'none') === shadow.value
                    ? 'border-purple-500 bg-purple-50'
                    : 'border-gray-200 hover:border-gray-300'
                }`}
              >
                {shadow.label}
              </button>
            ))}
          </div>
        </div>

        {/* Êª§Èïú */}
        <div>
          <h4 className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-3">
            <Palette size={14} />
            Êª§Èïú
          </h4>
          <div className="space-y-3">
            {/* ‰∫ÆÂ∫¶ */}
            <div>
              <div className="flex items-center justify-between mb-1">
                <label className="text-xs text-gray-600 flex items-center gap-1">
                  <Sun size={12} />
                  ‰∫ÆÂ∫¶
                </label>
                <span className="text-xs text-gray-500">
                  {parseFloatValue(currentStyles.brightness, 100)}%
                </span>
              </div>
              <input
                type="range"
                min="0"
                max="200"
                value={parseFloatValue(currentStyles.brightness, 100)}
                onChange={(e) => updateStyle('brightness', e.target.value)}
                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
              />
            </div>

            {/* ÂØπÊØîÂ∫¶ */}
            <div>
              <div className="flex items-center justify-between mb-1">
                <label className="text-xs text-gray-600 flex items-center gap-1">
                  <Contrast size={12} />
                  ÂØπÊØîÂ∫¶
                </label>
                <span className="text-xs text-gray-500">
                  {parseFloatValue(currentStyles.contrast, 100)}%
                </span>
              </div>
              <input
                type="range"
                min="0"
                max="200"
                value={parseFloatValue(currentStyles.contrast, 100)}
                onChange={(e) => updateStyle('contrast', e.target.value)}
                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
              />
            </div>

            {/* È•±ÂíåÂ∫¶ */}
            <div>
              <div className="flex items-center justify-between mb-1">
                <label className="text-xs text-gray-600">È•±ÂíåÂ∫¶</label>
                <span className="text-xs text-gray-500">
                  {parseFloatValue(currentStyles.saturate, 100)}%
                </span>
              </div>
              <input
                type="range"
                min="0"
                max="200"
                value={parseFloatValue(currentStyles.saturate, 100)}
                onChange={(e) => updateStyle('saturate', e.target.value)}
                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
              />
            </div>

            {/* Ê®°Á≥ä */}
            <div>
              <div className="flex items-center justify-between mb-1">
                <label className="text-xs text-gray-600">Ê®°Á≥ä</label>
                <span className="text-xs text-gray-500">
                  {parseFloatValue(currentStyles.blur, 0)}px
                </span>
              </div>
              <input
                type="range"
                min="0"
                max="20"
                value={parseFloatValue(currentStyles.blur, 0)}
                onChange={(e) => updateStyle('blur', e.target.value)}
                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
              />
            </div>

            {/* Â∫îÁî®Êª§ÈïúÊåâÈíÆ */}
            <button
              onClick={() => {
                const brightness = parseFloatValue(currentStyles.brightness, 100);
                const contrast = parseFloatValue(currentStyles.contrast, 100);
                const saturate = parseFloatValue(currentStyles.saturate, 100);
                const blur = parseFloatValue(currentStyles.blur, 0);
                const filterString = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturate}%) blur(${blur}px)`;
                updateStyle('filter', filterString);
              }}
              className="w-full text-xs py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors"
            >
              Â∫îÁî®Êª§Èïú
            </button>
          </div>
        </div>

        {/* ÈÄèÊòéÂ∫¶ */}
        <div>
          <h4 className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-3">
            ÈÄèÊòéÂ∫¶
          </h4>
          <div className="flex items-center gap-2">
            <input
              type="range"
              min="0"
              max="100"
              value={parseFloatValue(currentStyles.opacity, 100) * 100}
              onChange={(e) => updateStyle('opacity', (e.target.value / 100).toFixed(2))}
              className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            />
            <span className="text-sm text-gray-600 min-w-[50px]">
              {Math.round(parseFloatValue(currentStyles.opacity, 1) * 100)}%
            </span>
          </div>
        </div>

        {/* ÁøªËΩ¨ÂíåÊóãËΩ¨ */}
        <div>
          <h4 className="flex items-center gap-2 text-sm font-medium text-gray-700 mb-3">
            <RotateCw size={14} />
            ÁøªËΩ¨ & ÊóãËΩ¨
          </h4>
          <div className="grid grid-cols-2 gap-2">
            <button
              onClick={handleFlipHorizontal}
              className="p-2 text-xs rounded-lg border border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition-all flex items-center justify-center gap-1"
            >
              <FlipHorizontal size={14} />
              Ê∞¥Âπ≥ÁøªËΩ¨
            </button>
            <button
              onClick={handleFlipVertical}
              className="p-2 text-xs rounded-lg border border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition-all flex items-center justify-center gap-1"
            >
              <FlipVertical size={14} />
              ÂûÇÁõ¥ÁøªËΩ¨
            </button>
            <button
              onClick={() => handleRotate(90)}
              className="p-2 text-xs rounded-lg border border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition-all"
            >
              ÊóãËΩ¨ 90¬∞
            </button>
            <button
              onClick={() => handleRotate(-90)}
              className="p-2 text-xs rounded-lg border border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition-all"
            >
              ÊóãËΩ¨ -90¬∞
            </button>
          </div>
        </div>

        {/* ÈáçÁΩÆÊåâÈíÆ */}
        <div className="pt-4 border-t border-gray-100">
          <button
            onClick={() => updateElementStyle(selected.id, {})}
            className="w-full py-2 px-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors text-sm"
          >
            ÈáçÁΩÆ‰∏∫ÈªòËÆ§Ê†∑Âºè
          </button>
        </div>
      </div>
    </div>
  );
}

export default ImageSidebar;
