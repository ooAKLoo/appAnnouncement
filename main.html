<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APP下载页面</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
    <!-- Excalidraw风格顶部工具栏 -->
    <div class="top-toolbar">
        <div class="toolbar-left">
            <button class="toolbar-tab" data-tab="template">
                <i data-lucide="layout-template" class="toolbar-tab-icon"></i>
                <span>模板</span>
            </button>
            <button class="toolbar-tab active" data-tab="app">
                <i data-lucide="smartphone" class="toolbar-tab-icon"></i>
                <span>APP配置</span>
            </button>
            <button class="toolbar-tab" data-tab="design">
                <i data-lucide="palette" class="toolbar-tab-icon"></i>
                <span>设计</span>
            </button>
        </div>
        
        <div class="toolbar-right">
            <div class="download-dropdown">
                <button class="download-btn-main" onclick="toggleDownloadMenu()">
                    <i data-lucide="download" class="download-icon"></i>
                    <span>下载</span>
                    <i data-lucide="chevron-down" class="chevron-icon"></i>
                </button>
                <div class="download-menu" id="downloadMenu">
                    <button class="download-option" onclick="downloadAs('png')">
                        <i data-lucide="image"></i>
                        <span>PNG 图片</span>
                    </button>
                    <button class="download-option" onclick="downloadAs('jpg')">
                        <i data-lucide="image"></i>
                        <span>JPG 图片</span>
                    </button>
                    <button class="download-option" onclick="downloadAs('pdf')">
                        <i data-lucide="file-text"></i>
                        <span>PDF 文档</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 左侧配置面板 -->
    <div class="left-config-panel">
        <!-- 模板选择 -->
        <div class="config-section" data-section="template">
            <div class="config-section-title">
                <i data-lucide="layout-template"></i>
                模板选择
            </div>
            
            <div class="config-group">
                <div class="config-group-label">布局样式</div>
                <div class="template-grid">
                    <div class="template-item active" data-template="classic">
                        <div class="template-preview">
                            <div class="template-preview-left">
                                <div class="template-preview-logo"></div>
                                <div class="template-preview-title"></div>
                                <div class="template-preview-desc"></div>
                                <div class="template-preview-btns"></div>
                            </div>
                            <div class="template-preview-phone"></div>
                        </div>
                        <div class="template-name">经典布局</div>
                        <div class="template-desc">左文右图，适合突出产品特性</div>
                    </div>
                    
                    <div class="template-item" data-template="center">
                        <div class="template-preview">
                            <div class="template-preview-center">
                                <div class="template-preview-logo"></div>
                                <div class="template-preview-title"></div>
                                <div class="template-preview-desc"></div>
                                <div class="template-preview-btns"></div>
                                <div class="template-preview-phone-small"></div>
                            </div>
                        </div>
                        <div class="template-name">居中布局</div>
                        <div class="template-desc">内容居中，简洁现代</div>
                    </div>
                    
                    <div class="template-item" data-template="minimal">
                        <div class="template-preview">
                            <div class="template-preview-minimal">
                                <div class="template-preview-title"></div>
                                <div class="template-preview-btns"></div>
                            </div>
                            <div class="template-preview-phone-large"></div>
                        </div>
                        <div class="template-name">极简布局</div>
                        <div class="template-desc">突出产品，最小干扰</div>
                    </div>
                    
                    <div class="template-item" data-template="elegant">
                        <div class="template-preview">
                            <div class="template-preview-elegant">
                                <div class="template-preview-logo-small"></div>
                                <div class="template-preview-title-elegant"></div>
                                <div class="template-preview-desc-elegant"></div>
                                <div class="template-preview-btns-elegant"></div>
                            </div>
                            <div class="template-preview-phone-float"></div>
                        </div>
                        <div class="template-name">优雅布局</div>
                        <div class="template-desc">精致设计，商务感强</div>
                    </div>
                    
                    <div class="template-item" data-template="light">
                        <div class="template-preview">
                            <div class="template-preview-light">
                                <div class="template-preview-title-light"></div>
                                <div class="template-preview-desc-light"></div>
                                <div class="template-preview-btns-light"></div>
                                <div class="template-preview-cards"></div>
                            </div>
                        </div>
                        <div class="template-name">轻盈布局</div>
                        <div class="template-desc">卡片式设计，现代简约</div>
                    </div>
                    
                    <div class="template-item" data-template="premium">
                        <div class="template-preview">
                            <div class="template-preview-premium">
                                <div class="template-preview-badge"></div>
                                <div class="template-preview-title-premium"></div>
                                <div class="template-preview-features"></div>
                                <div class="template-preview-btns-premium"></div>
                            </div>
                            <div class="template-preview-phone-premium"></div>
                        </div>
                        <div class="template-name">高级布局</div>
                        <div class="template-desc">奢华质感，突出品质</div>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- APP配置 -->
        <div class="config-section active" data-section="app">
            <div class="config-section-title">
                <i data-lucide="smartphone"></i>
                APP配置
            </div>
            
            <!-- 基本信息 -->
            <div class="config-group">
                <div class="config-group-label">基本信息</div>
                <input type="text" class="config-input" id="appNameInput" placeholder="输入APP名称" maxlength="20" style="margin-bottom: 8px;">
                <input type="text" class="config-input" id="mainTitleInput" placeholder="输入主标题" maxlength="50" style="margin-bottom: 8px;">
                <textarea class="config-input" id="appDescInput" placeholder="输入APP描述" maxlength="100" rows="3"></textarea>
            </div>
            
            <!-- 媒体资源 -->
            <div class="config-group">
                <div class="config-group-label">媒体资源</div>
                <input type="file" id="iconUpload" accept="image/*" style="display: none;">
                <div class="config-upload-btn" onclick="document.getElementById('iconUpload').click()" style="margin-bottom: 8px;">
                    <i data-lucide="image"></i>
                    选择APP图标
                </div>
                <input type="file" id="screenUpload" accept="image/*" style="display: none;">
                <div class="config-upload-btn" onclick="document.getElementById('screenUpload').click()">
                    <i data-lucide="monitor-smartphone"></i>
                    选择APP截图
                </div>
            </div>
            
            <!-- 下载链接 -->
            <div class="config-group">
                <div class="config-group-label">下载链接</div>
                <div class="config-checkbox-row" style="margin-bottom: 8px;">
                    <input type="checkbox" id="showAppStore" checked>
                    <label for="showAppStore" class="config-checkbox-label">显示 App Store</label>
                </div>
                <input type="url" class="config-input" id="appStoreInput" placeholder="App Store链接" style="margin-bottom: 12px;">
                
                <div class="config-checkbox-row" style="margin-bottom: 8px;">
                    <input type="checkbox" id="showGooglePlay" checked>
                    <label for="showGooglePlay" class="config-checkbox-label">显示 Google Play</label>
                </div>
                <input type="url" class="config-input" id="googlePlayInput" placeholder="Google Play链接">
            </div>
        </div>

        <!-- 设计配置 -->
        <div class="config-section" data-section="design">
            <div class="config-section-title">
                <i data-lucide="palette"></i>
                设计配置
            </div>
            
            <div class="config-group">
                <div class="config-group-label">配色方案</div>
                <div class="color-scheme-grid">
                    <div class="color-scheme-item active" data-scheme="blue">
                        <div class="color-scheme-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                        <div class="color-scheme-name">科技蓝</div>
                    </div>
                    <div class="color-scheme-item" data-scheme="purple">
                        <div class="color-scheme-preview" style="background: linear-gradient(135deg, #8B5CF6 0%, #A855F7 100%);"></div>
                        <div class="color-scheme-name">优雅紫</div>
                    </div>
                    <div class="color-scheme-item" data-scheme="green">
                        <div class="color-scheme-preview" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);"></div>
                        <div class="color-scheme-name">自然绿</div>
                    </div>
                    <div class="color-scheme-item" data-scheme="orange">
                        <div class="color-scheme-preview" style="background: linear-gradient(135deg, #F97316 0%, #EA580C 100%);"></div>
                        <div class="color-scheme-name">活力橙</div>
                    </div>
                </div>
            </div>

            <div class="config-group">
                <div class="config-group-label">自定义颜色</div>
                <div class="config-color-row" style="margin-bottom: 12px;">
                    <input type="color" class="config-color-input" id="bgColorInput" value="#667eea">
                    <div class="config-color-label">主色调</div>
                </div>
                <div class="config-color-row">
                    <input type="color" class="config-color-input" id="gradientColorInput" value="#764ba2">
                    <div class="config-color-label">渐变色</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 背景装饰 -->
    <div class="bg-decoration decoration-1"></div>
    <div class="bg-decoration decoration-2"></div>

    <div class="container">
        <!-- 图片预览 -->
        <div class="image-preview" id="imagePreview">
            <img id="previewImg" src="" alt="APP截图预览">
            <div class="preview-label">APP截图预览</div>
        </div>

        <div class="content-wrapper">
            <!-- 左侧内容 -->
            <div class="left-content">
                <div class="app-logo">
                    <div class="logo-icon">B</div>
                    <div class="logo-text">Bompay</div>
                </div>

                <h1 class="main-title">Download Bompay today</h1>

                <p class="subtitle">
                    体验全新的支付方式，让生活更简单
                </p>

                <div class="download-buttons">
                    <a href="#" class="download-btn">
                        <svg class="store-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z" />
                        </svg>
                        <span>App Store</span>
                    </a>
                    <a href="#" class="download-btn">
                        <svg class="store-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M3,20.5V3.5C3,2.91 3.34,2.39 3.84,2.15L13.69,12L3.84,21.85C3.34,21.6 3,21.09 3,20.5M16.81,15.12L6.05,21.34L14.54,12.85L16.81,15.12M20.16,10.81C20.5,11.08 20.75,11.5 20.75,12C20.75,12.5 20.5,12.92 20.16,13.19L17.89,14.5L15.39,12L17.89,9.5L20.16,10.81M6.05,2.66L16.81,8.88L14.54,11.15L6.05,2.66Z" />
                        </svg>
                        <span>Google Play</span>
                    </a>
                </div>

                <!-- APP配置和上传控件 -->
                <div class="config-panel">
                    <h3 style="color: white; margin-bottom: 20px; font-size: 18px;">自定义你的APP展示</h3>

                    <div class="upload-container">
                        <input type="file" id="screenUpload" accept="image/*" style="display: none;">
                        <input type="file" id="iconUpload" accept="image/*" style="display: none;">
                        <button class="upload-btn" onclick="document.getElementById('screenUpload').click()">
                            📱 上传APP截图
                        </button>
                        <button class="upload-btn" onclick="document.getElementById('iconUpload').click()">
                            🎨 上传APP图标
                        </button>
                        <button class="upload-btn secondary" onclick="useDefaultScreen()">
                            🖼️ 使用示例
                        </button>
                    </div>

                    <div class="config-inputs">
                        <input type="text" id="appNameInput" placeholder="APP名称" maxlength="20">
                        <textarea id="appDescInput" placeholder="APP描述" maxlength="100" rows="2"></textarea>
                        <input type="color" id="bgColorInput" value="#667eea" title="选择背景色">
                        <label for="bgColorInput" style="color: white; font-size: 14px; margin-top: 5px;">背景颜色</label>
                    </div>
                </div>
            </div>

            <!-- 右侧3D手机模型 -->
            <div class="phone-container">
                <div id="canvas-container">
                    <div class="loading-indicator" id="loading">
                        <div class="loading-spinner"></div>
                        <div>加载3D模型中...</div>
                    </div>
                </div>

                <!-- 手机屏幕内容（可选） -->
                <div class="screen-content" id="screenContent">
                    <div class="screen-inner">
                        <div class="app-icon-preview">B</div>
                        <div class="app-name-preview">Bompay</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入Three.js和GLTFLoader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>

    <script>
        // 配置对象
        const config = {
            // APP信息
            appName: 'Bompay',
            appIcon: 'B',
            mainTitle: 'Download Bompay today',
            subtitle: '体验全新的支付方式，让生活更简单',

            // 下载链接
            appStoreLink: 'https://apps.apple.com/app/your-app',
            googlePlayLink: 'https://play.google.com/store/apps/details?id=your.app',

            // 3D模型路径（请将文件放在与HTML同目录下）
            modelPath: 'models/apple_iphone_15_pro_max_black.glb',

            // 颜色主题
            primaryColor: '#667eea',
            secondaryColor: '#764ba2'
        };

        // 应用配置
        function applyConfig() {
            document.querySelector('.logo-text').textContent = config.appName;
            document.querySelector('.logo-icon').textContent = config.appIcon;
            document.querySelector('.main-title').textContent = config.mainTitle;
            document.querySelector('.subtitle').textContent = config.subtitle;
            document.querySelector('.app-icon-preview').textContent = config.appIcon;
            document.querySelector('.app-name-preview').textContent = config.appName;

            document.querySelectorAll('.download-btn')[0].href = config.appStoreLink;
            document.querySelectorAll('.download-btn')[1].href = config.googlePlayLink;

            // 初始化配置面板中的输入框值
            const appNameInput = document.getElementById('appNameInput');
            const mainTitleInput = document.getElementById('mainTitleInput');
            const appDescInput = document.getElementById('appDescInput');
            const appStoreInput = document.getElementById('appStoreInput');
            const googlePlayInput = document.getElementById('googlePlayInput');

            if (appNameInput) appNameInput.value = config.appName;
            if (mainTitleInput) mainTitleInput.value = config.mainTitle;
            if (appDescInput) appDescInput.value = config.subtitle;
            if (appStoreInput) appStoreInput.value = config.appStoreLink;
            if (googlePlayInput) googlePlayInput.value = config.googlePlayLink;
        }

        // Three.js 3D场景设置
        let scene, camera, renderer, model, controls;

        function init3D() {
    const container = document.getElementById('canvas-container');
    const width = container.clientWidth;
    const height = container.clientHeight;

    // 创建场景
    scene = new THREE.Scene();
    
    // 创建相机
    camera = new THREE.PerspectiveCamera(35, width / height, 0.1, 1000);
    camera.position.set(0, 0, 5);

    // 创建渲染器 - 添加正确的渲染设置
    renderer = new THREE.WebGLRenderer({ 
        antialias: true, 
        alpha: true 
    });
    renderer.setSize(width, height);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    
    // 关键：设置正确的色彩空间和色调映射
    renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.4;
    
    container.appendChild(renderer.domElement);

    // 添加环境光照
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight.position.set(5, 5, 5);
    directionalLight.castShadow = true;
    scene.add(directionalLight);

    const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
    backLight.position.set(-5, 3, -5);
    scene.add(backLight);

    // 添加点光源增强高光
    const pointLight = new THREE.PointLight(0xffffff, 0.5);
    pointLight.position.set(2, 3, 4);
    scene.add(pointLight);

    // 创建简单的环境贴图（渐变天空）
    const pmremGenerator = new THREE.PMREMGenerator(renderer);
    pmremGenerator.compileEquirectangularShader();
    
    // 创建渐变环境
    const envScene = new THREE.Scene();
    envScene.background = new THREE.Color(0xf0f0f0);
    const envTexture = pmremGenerator.fromScene(envScene).texture;
    scene.environment = envTexture;

    // 轨道控制
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.rotateSpeed = 0.5;
    controls.minDistance = 3;
    controls.maxDistance = 8;
    controls.enablePan = false;

    // 加载GLTF模型
    const loader = new THREE.GLTFLoader();
    
    loader.load(
        config.modelPath,
        function (gltf) {
            model = gltf.scene;
            
            // 居中和缩放
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            model.position.sub(center);
            
            const size = box.getSize(new THREE.Vector3());
            const maxSize = Math.max(size.x, size.y, size.z);
            const targetSize = 3;
            model.scale.multiplyScalar(targetSize / maxSize);
            
            model.rotation.y = -Math.PI / 6;
            
            // 关键改动：保留原始材质，只调整必要属性
            model.traverse((child) => {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                    
                    // 不要替换材质！只在必要时修复
                    if (child.material) {
                        // 确保材质响应环境光
                        if (child.material.isMeshStandardMaterial || 
                            child.material.isMeshPhysicalMaterial) {
                            child.material.envMapIntensity = 1.5;
                            child.material.needsUpdate = true;
                        }
                    }
                }
            });
            
            scene.add(model);
            document.getElementById('loading').style.display = 'none';
            
            // 清理
            pmremGenerator.dispose();
            
            animate();
        },
        function (xhr) {
            if (xhr.total > 0) {
                const percentComplete = (xhr.loaded / xhr.total) * 100;
                console.log('加载进度：' + percentComplete.toFixed(2) + '%');
            }
        },
        function (error) {
            console.error('模型加载错误：', error);
            // 错误处理保持不变
        }
    );

    window.addEventListener('resize', onWindowResize);
}

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        function animate() {
            requestAnimationFrame(animate);

            // 更新控制器
            controls.update();

            // 自动旋转（可选）
            if (model && !controls.autoRotate) {
                // model.rotation.y += 0.002;
            }

            renderer.render(scene, camera);
        }

        // 图片上传和3D屏幕替换功能
        let currentScreenMesh = null;

        // 模板切换功能
        function initTemplateSwitching() {
            const templateItems = document.querySelectorAll('.template-item');
            const colorSchemeItems = document.querySelectorAll('.color-scheme-item');

            // 模板布局切换
            templateItems.forEach(item => {
                item.addEventListener('click', function() {
                    templateItems.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const template = this.dataset.template;
                    switchTemplate(template);
                });
            });

            // 配色方案切换
            colorSchemeItems.forEach(item => {
                item.addEventListener('click', function() {
                    colorSchemeItems.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    
                    const scheme = this.dataset.scheme;
                    applyColorScheme(scheme);
                });
            });
        }

        // 切换模板布局
        function switchTemplate(template) {
            const container = document.querySelector('.container');
            const contentWrapper = document.querySelector('.content-wrapper');
            
            // 移除所有模板类
            container.classList.remove('template-classic', 'template-center', 'template-minimal', 'template-elegant', 'template-light', 'template-premium');
            
            // 应用新模板类
            container.classList.add(`template-${template}`);
            
            console.log(`切换到模板: ${template}`);
        }

        // 应用配色方案
        function applyColorScheme(scheme) {
            const colorSchemes = {
                blue: { primary: '#667eea', secondary: '#764ba2' },
                purple: { primary: '#8B5CF6', secondary: '#A855F7' },
                green: { primary: '#10B981', secondary: '#059669' },
                orange: { primary: '#F97316', secondary: '#EA580C' }
            };
            
            const colors = colorSchemes[scheme];
            if (colors) {
                updateBackgroundColor(colors.primary, colors.secondary);
                
                // 同步更新设计面板中的颜色选择器
                const bgColorInput = document.getElementById('bgColorInput');
                const gradientColorInput = document.getElementById('gradientColorInput');
                if (bgColorInput) bgColorInput.value = colors.primary;
                if (gradientColorInput) gradientColorInput.value = colors.secondary;
                
                config.primaryColor = colors.primary;
                config.secondaryColor = colors.secondary;
                
                console.log(`应用配色方案: ${scheme}`);
            }
        }

        // 标签页切换功能
        function initTabSwitching() {
            const toolbarTabs = document.querySelectorAll('.toolbar-tab');
            const configSections = document.querySelectorAll('.config-section');

            toolbarTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    // 移除所有活动状态
                    toolbarTabs.forEach(t => t.classList.remove('active'));
                    configSections.forEach(s => s.classList.remove('active'));
                    
                    // 激活当前标签和对应配置区域
                    this.classList.add('active');
                    const targetSection = document.querySelector(`[data-section="${targetTab}"]`);
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }
                });
            });
        }

        function initImageUpload() {
            const uploadInput = document.getElementById('screenUpload');
            const iconUploadInput = document.getElementById('iconUpload');
            const appNameInput = document.getElementById('appNameInput');
            const mainTitleInput = document.getElementById('mainTitleInput');
            const appDescInput = document.getElementById('appDescInput');
            const bgColorInput = document.getElementById('bgColorInput');
            const gradientColorInput = document.getElementById('gradientColorInput');
            const appStoreInput = document.getElementById('appStoreInput');
            const googlePlayInput = document.getElementById('googlePlayInput');
            const showAppStoreCheckbox = document.getElementById('showAppStore');
            const showGooglePlayCheckbox = document.getElementById('showGooglePlay');

            // 图片上传处理
            uploadInput.addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        updateScreenWithImage(e.target.result);
                        showImagePreview(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // APP图标上传处理
            iconUploadInput.addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        updateAppIcon(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // APP名称变更
            appNameInput.addEventListener('input', function (e) {
                const newName = e.target.value || config.appName;
                document.querySelector('.logo-text').textContent = newName;
                document.querySelector('.app-name-preview').textContent = newName;
                config.appName = newName;
            });

            // 主标题变更
            mainTitleInput.addEventListener('input', function (e) {
                const newTitle = e.target.value || config.mainTitle;
                document.querySelector('.main-title').textContent = newTitle;
                config.mainTitle = newTitle;
            });

            // APP描述变更
            appDescInput.addEventListener('input', function (e) {
                const newDesc = e.target.value || config.subtitle;
                document.querySelector('.subtitle').textContent = newDesc;
                config.subtitle = newDesc;
            });

            // 背景颜色变更
            bgColorInput.addEventListener('input', function (e) {
                const newColor = e.target.value;
                updateBackgroundColor(newColor, gradientColorInput.value);
                config.primaryColor = newColor;
            });

            // 渐变颜色变更
            gradientColorInput.addEventListener('input', function (e) {
                const newColor = e.target.value;
                updateBackgroundColor(bgColorInput.value, newColor);
                config.secondaryColor = newColor;
            });

            // App Store链接变更
            appStoreInput.addEventListener('input', function (e) {
                const newLink = e.target.value || config.appStoreLink;
                document.querySelectorAll('.download-btn')[0].href = newLink;
                config.appStoreLink = newLink;
            });

            // Google Play链接变更
            googlePlayInput.addEventListener('input', function (e) {
                const newLink = e.target.value || config.googlePlayLink;
                document.querySelectorAll('.download-btn')[1].href = newLink;
                config.googlePlayLink = newLink;
            });

            // App Store显示控制
            showAppStoreCheckbox.addEventListener('change', function (e) {
                const appStoreBtn = document.querySelectorAll('.download-btn')[0];
                if (e.target.checked) {
                    appStoreBtn.style.display = 'inline-flex';
                } else {
                    appStoreBtn.style.display = 'none';
                }
            });

            // Google Play显示控制
            showGooglePlayCheckbox.addEventListener('change', function (e) {
                const googlePlayBtn = document.querySelectorAll('.download-btn')[1];
                if (e.target.checked) {
                    googlePlayBtn.style.display = 'inline-flex';
                } else {
                    googlePlayBtn.style.display = 'none';
                }
            });
        }

        function showImagePreview(imageSrc) {
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');

            previewImg.src = imageSrc;
            preview.classList.add('show');

            // 3秒后自动隐藏预览
            setTimeout(() => {
                preview.classList.remove('show');
            }, 3000);
        }

  function updateScreenWithImage(imageSrc) {
    if (!model) {
        console.warn('3D模型尚未加载完成');
        return;
    }
    
    let screenFound = false;
    
    model.traverse((child) => {
        if (child.isMesh && child.name === 'xXDHkMplTIDAXLN') {
            console.log('找到iPhone屏幕网格！');
            
            const textureLoader = new THREE.TextureLoader();
            const screenTexture = textureLoader.load(imageSrc, function(texture) {
                // 关键修改：调整贴图映射
                texture.flipY = true;
                texture.wrapS = THREE.RepeatWrapping;  // 改为重复模式
                texture.wrapT = THREE.RepeatWrapping;  
                texture.encoding = THREE.sRGBEncoding;
                
                // 添加：确保贴图完全覆盖
                texture.repeat.set(1, 1);
                texture.offset.set(0, 0);
                
                // 添加：调整贴图中心点
                texture.center.set(0.5, 0.5);
                
                const screenMaterial = new THREE.MeshStandardMaterial({
                    map: texture,
                    roughness: 1,
                    metalness: 0,
                    envMapIntensity: 0.5,
                    // 添加：确保不透明
                    transparent: false,
                    opacity: 1,
                    side: THREE.FrontSide
                });
                
                child.material = screenMaterial;
                child.material.needsUpdate = true;
                
                // 添加：检查并调整底部黑色区域
                child.geometry.computeBoundingBox();
                
                currentScreenMesh = child;
                screenFound = true;
            });
        }
    });
    
    if (!screenFound) {
        console.warn('未找到屏幕网格 xXDHkMplTIDAXLN');
        // 备用方案：寻找其他可能的屏幕网格
        searchAlternativeScreen();
    }
}

// 添加备用搜索函数
function searchAlternativeScreen() {
    model.traverse((child) => {
        if (child.isMesh && child.material) {
            // 查找可能是屏幕的材质
            if (child.material.name === 'pIJKfZsazmcpEiU' || 
                child.geometry.boundingBox) {
                const box = new THREE.Box3().setFromObject(child);
                const size = box.getSize(new THREE.Vector3());
                // 判断是否为屏幕尺寸的网格
                if (size.y > size.x * 1.5 && size.y < size.x * 2.5) {
                    console.log('找到备用屏幕网格:', child.name);
                    // 应用贴图...
                }
            }
        }
    });
}
       function useDefaultScreen() {
            // 创建一个默认的APP截图效果
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 800;
            const ctx = canvas.getContext('2d');

            // 绘制渐变背景
            const gradient = ctx.createLinearGradient(0, 0, 0, 800);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 400, 800);

            // 绘制APP图标
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(150, 200, 100, 100);
            ctx.fillStyle = '#667eea';
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('B', 200, 265);

            // 绘制APP名称
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 24px Arial';
            ctx.fillText(config.appName, 200, 340);

            // 绘制描述文字
            ctx.font = '16px Arial';
            ctx.fillText('体验全新的支付方式', 200, 380);
            ctx.fillText('让生活更简单', 200, 410);

            // 绘制一些UI元素
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.fillRect(40, 500, 320, 60);
            ctx.fillRect(40, 580, 320, 60);
            ctx.fillRect(40, 660, 320, 60);

            const defaultImage = canvas.toDataURL('image/png');
            updateScreenWithImage(defaultImage);
            showImagePreview(defaultImage);
        }

        // APP图标更新函数
        function updateAppIcon(iconSrc) {
            // 更新主logo图标
            const logoIcon = document.querySelector('.logo-icon');
            logoIcon.style.backgroundImage = `url(${iconSrc})`;
            logoIcon.style.backgroundSize = 'cover';
            logoIcon.style.backgroundPosition = 'center';
            logoIcon.textContent = '';

            // 更新屏幕预览中的图标
            const appIconPreview = document.querySelector('.app-icon-preview');
            appIconPreview.style.backgroundImage = `url(${iconSrc})`;
            appIconPreview.style.backgroundSize = 'cover';
            appIconPreview.style.backgroundPosition = 'center';
            appIconPreview.textContent = '';
        }

        // 背景颜色更新函数
        function updateBackgroundColor(primaryColor, secondaryColor = null) {
            // 如果没有提供第二个颜色，自动计算
            const gradientColor = secondaryColor || adjustBrightness(primaryColor, -40);
            
            // 更新body背景
            document.body.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${gradientColor} 100%)`;
            
            // 更新屏幕内容背景
            const screenInner = document.querySelector('.screen-inner');
            if (screenInner) {
                screenInner.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${gradientColor} 100%)`;
            }

            // 更新logo图标颜色
            const logoIcon = document.querySelector('.logo-icon');
            if (logoIcon && !logoIcon.style.backgroundImage) {
                logoIcon.style.color = primaryColor;
            }

            // 更新app图标预览颜色
            const appIconPreview = document.querySelector('.app-icon-preview');
            if (appIconPreview && !appIconPreview.style.backgroundImage) {
                appIconPreview.style.color = primaryColor;
            }
        }

        // 颜色亮度调整函数
        function adjustBrightness(hex, percent) {
            const num = parseInt(hex.replace("#",""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255))
                .toString(16).slice(1);
        }

        // 下载功能
        function toggleDownloadMenu() {
            const dropdown = document.querySelector('.download-dropdown');
            const menu = document.getElementById('downloadMenu');
            
            dropdown.classList.toggle('active');
            menu.classList.toggle('show');
        }

        // 点击外部关闭下载菜单
        document.addEventListener('click', function(e) {
            const dropdown = document.querySelector('.download-dropdown');
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
                document.getElementById('downloadMenu').classList.remove('show');
            }
        });

        async function downloadAs(format) {
            // 关闭下载菜单
            document.querySelector('.download-dropdown').classList.remove('active');
            document.getElementById('downloadMenu').classList.remove('show');
            
            // 临时隐藏工具栏和配置面板
            const toolbar = document.querySelector('.top-toolbar');
            const configPanel = document.querySelector('.left-config-panel');
            const imagePreview = document.querySelector('.image-preview');
            
            toolbar.style.display = 'none';
            configPanel.style.display = 'none';
            imagePreview.style.display = 'none';
            
            try {
                // 获取要截图的区域
                const container = document.querySelector('.container');
                
                // 使用 html2canvas 截图
                const canvas = await html2canvas(container, {
                    backgroundColor: null,
                    scale: 2, // 提高图片质量
                    useCORS: true,
                    allowTaint: true,
                    width: container.scrollWidth,
                    height: container.scrollHeight
                });
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const appName = config.appName || 'APP';
                
                if (format === 'png') {
                    // 下载 PNG
                    const link = document.createElement('a');
                    link.download = `${appName}-宣发页面-${timestamp}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                } else if (format === 'jpg') {
                    // 下载 JPG
                    const link = document.createElement('a');
                    link.download = `${appName}-宣发页面-${timestamp}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    
                } else if (format === 'pdf') {
                    // 下载 PDF
                    const { jsPDF } = window.jspdf;
                    const imgData = canvas.toDataURL('image/png');
                    
                    // 计算PDF尺寸
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = imgWidth / imgHeight;
                    
                    let pdfWidth, pdfHeight;
                    if (ratio > 1) {
                        // 横向
                        pdfWidth = 297; // A4 横向宽度 (mm)
                        pdfHeight = 297 / ratio;
                    } else {
                        // 纵向
                        pdfHeight = 210; // A4 纵向高度 (mm) 
                        pdfWidth = 210 * ratio;
                    }
                    
                    const pdf = new jsPDF(ratio > 1 ? 'landscape' : 'portrait', 'mm', 'a4');
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`${appName}-宣发页面-${timestamp}.pdf`);
                }
                
            } catch (error) {
                console.error('下载失败:', error);
                alert('下载失败，请稍后重试');
            } finally {
                // 恢复显示工具栏和配置面板
                toolbar.style.display = 'flex';
                configPanel.style.display = 'block';
                imagePreview.style.display = 'block';
            }
        }

        // 页面加载完成后初始化
        window.addEventListener('load', () => {
            applyConfig();
            init3D();
            initImageUpload();
            initTabSwitching();
            initTemplateSwitching();
            
            // 初始化 Lucide 图标
            lucide.createIcons();
        });
    </script>
</body>

</html>